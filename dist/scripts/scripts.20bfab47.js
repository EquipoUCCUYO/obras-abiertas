"use strict";$.urlParam=function(a,b){var c=new RegExp("[?&]"+b+"=([^&#]*)").exec(a);return null===c?null:c[1]||0},angular.module("obrasMduytApp",["ngRoute","ngSanitize","slugifier"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/obra/:id",{templateUrl:"views/obra.html",controller:"ObraCtrl",controllerAs:"obra"}).when("/entorno/:entorno",{templateUrl:"views/entorno.html",controller:"EntornoCtrl",controllerAs:"entorno"}).otherwise({redirectTo:"/home"})}]).service("DataService",["$http","$q","Slug",function(a,b,c){var d=void 0,e=function(a){return a.entorno_slug=a.entorno?c.slugify(a.entorno):null,a.tipo=a.tipo?a.tipo.split("|"):[],a.comuna=a.comuna?a.comuna.split("|"):[],a.barrio=a.barrio?a.barrio.split("|"):[],a.licitacion_oferta_empresas=a.licitacion_oferta_empresas?a.licitacion_oferta_empresas.split("|"):[],a.id=parseInt(a.id),a.licitacion_anio=a.licitacion_anio?parseInt(a.licitacion_anio):null,a.monto_contrato=a.monto_contrato?parseFloat(a.monto_contrato):null,a.licitacion_presupuesto_oficial=a.licitacion_presupuesto_oficial?parseFloat(a.licitacion_presupuesto_oficial):null,a.plazo_meses=a.plazo_meses?parseInt(a.plazo_meses):null,a.porcentaje_avance=a.porcentaje_avance?parseFloat(a.porcentaje_avance):null,a},f=function(){return window.MDUYT_CONFIG||(console.error("Archivo de configuración inexistente, utilizando configuración default de desarrollo."),window.MDUYT_CONFIG={BASE_URL:"http://api.topranking.link/",HOME_CSV:"https://goo.gl/vcb6oX"}),window.MDUYT_CONFIG.BASE_URL+"?source_format=csv&source="+window.MDUYT_CONFIG.HOME_CSV+"&callback=JSON_CALLBACK"};this.getById=function(a){var c=void 0,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.id==parseInt(a)}),d.resolve(c[0])}),c=d.promise,b.when(c)},this.getByEntorno=function(a){var c=void 0,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.entorno_slug==a}),d.resolve(c)}),c=d.promise,b.when(c)},this.getAll=function(){var a=void 0,c=b.defer();return this.retrieveAll().then(function(a){c.resolve(a)}),a=c.promise,b.when(a)},this.retrieveAll=function(){if(!d){var c=b.defer();a.jsonp(f()).then(function(a){d=a.data.map(e),c.resolve(d)},function(a){d=a,c.reject(a)}),d=c.promise}return b.when(d)}}]).run(["$rootScope","$interval",function(a,b){}]),angular.module("obrasMduytApp").controller("HomeCtrl",["$scope","DataService",function(a,b){function c(){h.w=d3.select("#home-chart-container").node().getBoundingClientRect().width,h.w=!h.svg||h.w<500?h.w-15:h.w,a.isSmallDevice=h.w<500?!0:!1,a.isSmallDevice?(h.h=h.w,h.margin=h.w/100):(h.h=3*h.w/4,h.margin=h.w/200),h.svg||(h.svg=d3.select("#home-chart-container").append("svg"),h.mainGroup=h.svg.append("g").classed("main-group",!0),h.mainGroup.append("rect").attr("fill","white")),h.svg.attr("width",h.w).attr("height",h.h),h.mainGroup.select("rect").attr("width",h.w).attr("height",h.h),a.showGroup(a.selectedGroup)}function d(){function b(){a.isSmallDevice&&h.svg.attr("height",h.w),h.mapGroup.selectAll("path.map-item").transition().attr("d",h.mapPath).style("opacity",1)}h.mapProjection=d3.geo.mercator().center([-58.43992,-34.618]).translate([h.w/2,h.h/2]).scale(190*h.w),h.mapPath=d3.geo.path().projection(h.mapProjection),h.mapGroup?b():(h.mapGroup=h.svg.append("g").attr("id","map-group"),d3.json("geo/comunas.simple.geojson",function(a){h.mapFeatures=a.features,h.mapGroup.selectAll("path.map-item").data(h.mapFeatures).enter().append("path").classed("child",!0).classed("map-item",!0).attr("id",function(a){return a.id}).classed("shape",!0),b()}))}function e(){var b=d3.range(1,16);if(h.comunasGroup||(h.comunasGroup=h.svg.append("g").attr("id","comunas-group"),h.comunasGroup.selectAll("g.comunas-item").data(b).enter().append("g").classed("child",!0).classed("comunas-item",!0).attr("id",function(a){return"comunas-item-"+a}).each(function(a){var b=d3.select(this);b.append("rect").classed("comunas-item-frame",!0).attr("fill","#ccc"),b.append("text").classed("comunas-item-text",!0).attr("fill","#000").text(function(a){return"Comuna "+a})})),a.isSmallDevice){var c=h.w,d=h.w;h.svg.attr("height",b.length*h.w),h.mainGroup.select("rect").attr("height",b.length*h.w)}else var c=h.h/3,d=h.w/5;h.comunasGroup.selectAll("rect.comunas-item-frame").transition().attr("x",h.margin).attr("y",h.margin).attr("height",c-2*h.margin).attr("width",d-2*h.margin),h.comunasGroup.selectAll("text.comunas-item-text").transition().attr("x",15).attr("y",25),g(h.comunasGroup.selectAll("g.comunas-item").transition().style("opacity",1),d,c)}function f(){var b=d3.range(1,5);if(h.etapasGroup||(h.etapasGroup=h.svg.append("g").attr("id","etapas-group"),h.etapasGroup.selectAll("g.etapas-item").data(b).enter().append("g").classed("child",!0).classed("etapas-item",!0).attr("id",function(a){return"etapas-item-"+a}).each(function(a){var b=d3.select(this);b.append("rect").classed("etapas-item-frame",!0).attr("fill","#ccc"),b.append("text").classed("etapas-item-text",!0).attr("fill","#000").text(function(a){return"Etapa "+a})})),a.isSmallDevice){var c=h.w,d=h.w;h.svg.attr("height",b.length*h.w),h.mainGroup.select("rect").attr("height",b.length*h.w)}else var c=h.h/2,d=h.w/2;h.etapasGroup.selectAll("rect.etapas-item-frame").transition().attr("x",h.margin).attr("y",h.margin).attr("height",c-2*h.margin).attr("width",d-2*h.margin),h.etapasGroup.selectAll("text.etapas-item-text").transition().attr("x",15).attr("y",25),g(h.etapasGroup.selectAll("g.etapas-item").transition().style("opacity",1),d,c)}function g(a,b,c){var d=Math.floor(h.w/b),e=0,f=0;a.transition().duration(1e3).attr("transform",function(g,h){var i=e*b,j=f*c;return d-1>e?e++:a[0].length!==h+1&&(e=0,f++),"translate("+i+","+j+")"})}a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.timeoutId;var h={};a.isSmallDevice,a.selectedGroup="comunas",b.getAll().then(function(b){console.log(b),a.obras=b,c(),$(window).resize(function(){clearTimeout(a.timeoutId),a.timeoutId=setTimeout(c,1e3)})});var i={comunas:e,etapas:f,map:d};a.showGroup=function(b){a.selectedGroup!=b&&(h.svg.selectAll(".child").style("opacity",0),a.selectedGroup=b),i[b]()}}]),angular.module("obrasMduytApp").controller("ObraCtrl",["$scope","DataService","$routeParams",function(a,b,c){a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.obraId=c.id,b.getById(c.id).then(function(b){console.log(b),a.obra=b})}]),angular.module("obrasMduytApp").controller("EntornoCtrl",["$scope","DataService","$routeParams",function(a,b,c){a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),b.getByEntorno(c.entorno).then(function(b){a.entorno=c.entorno,console.log(b),a.obras=b})}]),angular.module("obrasMduytApp").run(["$templateCache",function(a){a.put("views/entorno.html",'<div class="row"> <div class="col-md-12"> <h1>Entorno: {{entorno}}</h1> <p>Obras: {{obras.length}}</p> <p ng-repeat="obra in obras"> Obra: {{$index+1}} -> {{obra}} </p> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Galería]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Datos]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Mapa]</h4> </div> </div>'),a.put("views/home.html",'<div class="row"> <div class="col-md-12"> <h1>HOME</h1> <p>Cargadas: {{obras.length}} obras</p> </div> </div> <div class="row"> <div class="col-sm-10"> <div id="home-chart-container"></div> </div> <div class="col-sm-2"> <a class="btn btn-default btn-block" ng-click="showGroup(\'map\')">Mapa</a> <a class="btn btn-default btn-block" ng-click="showGroup(\'comunas\')">Comunas</a> <a class="btn btn-default btn-block" ng-click="showGroup(\'etapas\')">Etapas</a> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Mapa tentativo]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Sankey]</h4> </div> </div>'),a.put("views/obra.html",'<div class="row"> <div class="col-md-12"> <h1>Id de Obra: {{obraId}}</h1> <p>Obra: {{obra}}</p> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Galería]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Datos]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Mapa]</h4> </div> </div>')}]);