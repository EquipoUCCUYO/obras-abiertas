d3.sankey=function(){function a(){n.forEach(function(a){a.sourceLinks=[],a.targetLinks=[]}),o.forEach(function(a){var b=a.source,c=a.target;"number"==typeof b&&(b=a.source=n[a.source]),"number"==typeof c&&(c=a.target=n[a.target]),b.sourceLinks.push(a),c.targetLinks.push(a)})}function b(){n.forEach(function(a){a.value=Math.max(d3.sum(a.sourceLinks,i),d3.sum(a.targetLinks,i))})}function c(){for(var a,b=n,c=0;b.length;)a=[],b.forEach(function(b){b.x=c,b.dx=k,b.sourceLinks.forEach(function(b){a.push(b.target)})}),b=a,++c;d(c),e((m[0]-k)/(c-1))}function d(a){n.forEach(function(b){b.sourceLinks.length||(b.x=a-1)})}function e(a){n.forEach(function(b){b.x*=a})}function f(a){function b(){var a=d3.min(g,function(a){return(m[1]-(a.length-1)*l)/d3.sum(a,i)});g.forEach(function(b){b.forEach(function(b,c){b.y=c,b.dy=b.value*a})}),o.forEach(function(b){b.dy=b.value*a})}function c(a){function b(a){return h(a.source)*a.value}g.forEach(function(c,d){c.forEach(function(c){if(c.targetLinks.length){var d=d3.sum(c.targetLinks,b)/d3.sum(c.targetLinks,i);c.y+=(d-h(c))*a}})})}function d(a){function b(a){return h(a.target)*a.value}g.slice().reverse().forEach(function(c){c.forEach(function(c){if(c.sourceLinks.length){var d=d3.sum(c.sourceLinks,b)/d3.sum(c.sourceLinks,i);c.y+=(d-h(c))*a}})})}function e(){g.forEach(function(a){var b,c,d,e=0,g=a.length;for(a.sort(f),d=0;g>d;++d)b=a[d],c=e-b.y,c>0&&(b.y+=c),e=b.y+b.dy+l;if(c=e-l-m[1],c>0)for(e=b.y-=c,d=g-2;d>=0;--d)b=a[d],c=b.y+b.dy+l-e,c>0&&(b.y-=c),e=b.y})}function f(a,b){return a.y-b.y}var g=d3.nest().key(function(a){return a.x}).sortKeys(d3.ascending).entries(n).map(function(a){return a.values});b(),e();for(var j=1;a>0;--a)d(j*=.99),e(),c(j),e()}function g(){function a(a,b){return a.source.y-b.source.y}function b(a,b){return a.target.y-b.target.y}n.forEach(function(c){c.sourceLinks.sort(b),c.targetLinks.sort(a)}),n.forEach(function(a){var b=0,c=0;a.sourceLinks.forEach(function(a){a.sy=b,b+=a.dy}),a.targetLinks.forEach(function(a){a.ty=c,c+=a.dy})})}function h(a){return a.y+a.dy/2}function i(a){return a.value}var j={},k=24,l=8,m=[1,1],n=[],o=[];return j.nodeWidth=function(a){return arguments.length?(k=+a,j):k},j.nodePadding=function(a){return arguments.length?(l=+a,j):l},j.nodes=function(a){return arguments.length?(n=a,j):n},j.links=function(a){return arguments.length?(o=a,j):o},j.size=function(a){return arguments.length?(m=a,j):m},j.layout=function(d){return a(),b(),c(),f(d),g(),j},j.relayout=function(){return g(),j},j.link=function(){function a(a){var c=a.source.x+a.source.dx,d=a.target.x,e=d3.interpolateNumber(c,d),f=e(b),g=e(1-b),h=a.source.y+a.sy+a.dy/2,i=a.target.y+a.ty+a.dy/2;return"M"+c+","+h+"C"+f+","+h+" "+g+","+i+" "+d+","+i}var b=.5;return a.curvature=function(c){return arguments.length?(b=+c,a):b},a},j},window.SLIDES_DATA=[{title:"",order:0,category:!1,slides:[{title:"Buenos Aires detrás de escena",description:"Millones de historias dan vida a nuestra Ciudad. Algunos disfrutan pasar horas bajo la sombra de un árbol en la plaza del barrio. Otros no frenan nunca: colectivos, subtes y trenes los llevan y traen de todas sus actividades diarias. ¿Qué es lo que más necesitás de tu Ciudad?",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/1.%20SUBE_animacion.gif"}]},{title:"El microcentro",order:1,category:"verde",slides:[{title:"El microcentro",description:"Para los que trabajan o hacen trámites en el microcentro, caminar era casi imposible. ¿Quién podía atravesar las veredas angostas sin esforzarse para esquivar autos y motos?",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/2.%20Florida%20Paula%20Soler%20Moya.jpg"},{title:"",description:"Esta zona tenía lo que se conoce como un índice de compacidad alto: demasiado espacio construido en relación al poco espacio público disponible. Los puntos más  oscuros del mapa representan las zonas que cuentan con menos espacio público, y por lo tanto el índice de compacidad es alto.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/3.%20Compacidad_pre_final.jpg"},{title:"",description:"Por eso transformamos el microcentro en un área de prioridad peatonal.",type:"image",url:"http://www.buenosaires.gob.ar/sites/gcaba/files/img_4675_retocada_2_1.jpg"},{title:"",description:"Miremos el mapa del indicador de compacidad corregida de nuevo: los puntos que vimos antes ya no son tan oscuros. Eso es porque hoy hay más espacio para caminar tranquilos entre tanto edificio. Hay más espacio para disfrutar. Pero todavía nos falta. Conocé más sobre las obras que estamos realizando en la calle Tacuarí.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/5.%20Compacidad_final.jpg"}]},{title:"Caminar por la Ciudad",order:2,category:"integrada",slides:[{title:"Caminar por la Ciudad",description:"Pero hacer espacio para que podamos andar a pie por las calles porteñas no es lo único que hace a una verdadera ciudad caminable. También importa que todo lo que te hace falta esté cerca tuyo. Una ciudad integrada es esa donde no necesitás viajar mucho para realizar tus actividades cotidianas. Si tu trabajo, los servicios y comercios que necesitás están al alcance de tu mano, entonces tenés más tiempo para vos.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/6.%20Caminabilidad_ninios.jpg"},{title:"",description:"La Comuna 8 es una de las zonas de la Ciudad con un índice de caminabilidad muy bajo, casi en cero, porque no tiene un buen equilibrio entre la actividad económica, comercial, cultural y/o recreativa. Algunas cuadras superan ampliamente la longitud promedio y superan a los extenuantes 1000 metros, otras incluso se cortan por las vías del ferrocarril o las autopistas. Se las conoce como barreras urbanas, que hacen que sea difícil moverse caminando en esa zona. Los puntos azules del mapa son los que peor resultado dan.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/6.%20Caminabilidad_final.jpg"},{title:"",description:"La construcción de la Villa Olímpica en esta zona es una oportunidad para mejorar en este aspecto: implica construir viviendas, abrir nuevas calles que reduzcan la longitud de las cuadras y sumar comercios y otras actividades económicas y recreativas.",type:"image",url:"http://www.buenosaires.gob.ar/sites/gcaba/files/styles/interna_pagina/public/villa_olimpica_05.jpg?itok=b_CiZ26W"}]},{title:"Un sur joven",order:3,category:"atractiva",slides:[{title:"Un sur joven",description:"La Comuna 8 es, además, una de las zonas de la Ciudad con mayor cantidad de jóvenes. El 35% de sus habitantes tiene menos de 19 años y casi el 50% menos de 40.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/7.%20Poblacion.jpg"},{title:"",description:"Por eso es importante no solo impulsar el desarrollo de viviendas, sino también incentivar la actividad económica, el empleo y las actividades deportivas. La creación del Distrito del Deporte en esta zona busca lograr ese objetivo a través de beneficios fiscales para atraer empresas que se radiquen en la zona.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/7.%20Deporte_2.jpg"}]},{title:"El equilibrio de la Ciudad",order:4,category:"equilibrada",slides:[{title:"El equilibrio de la Ciudad",description:"Cuanto más diversas son las actividades de una zona, mayor es su autonomía y su posibilidad de desarrollo. La diversidad nos permite construir una Ciudad más equilibrada.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/8.%20disfrute_market.jpg"},{title:"",description:"El indicador de equilibrio de usos mide la relación entre el uso residencial y no residencial del suelo: nos muestra dónde falta desarrollo y qué aspecto debemos fortalecer. Si miramos los barrios Urquiza, Coghlan y Saavedra encontramos muchos puntos de color rojo. Esto muestra que el indicador está muy bajo, porque es una zona que siempre fue residencial, de casas bajas y calles amplias.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/obrasfinales/Finales%20para%20las%20historias/7.%20Deporte_2.jpg"},{title:"",description:"En estas manzanas se encuentra el nuevo Barrio Parque Donado Holmberg, que potenciará el desarrollo social, cultural, económico y administrativo de la zona.",type:"image",url:"http://www.buenosaires.gob.ar/sites/gcaba/files/styles/interna_pagina/public/3_231.jpg"}]},{title:"Encuentro cercano con la Ciudad",order:5,category:"cercana",slides:[{title:"Encuentro cercano con la Ciudad",description:"Una ciudad es cercana cuando viajar de un extremo al otro es sencillo, accesible y sustentable.",type:"image",url:"https://media.giphy.com/media/MrmgBz2qYDtOE/giphy.gif"},{title:"",description:"La construcción del Metrobús en las principales arterias de Buenos Aires contribuye a que todos cuenten con transporte transporte público cómodo y rápido para que vayas a donde quieras, cuando quieras, sin tardar más de lo necesario. Porque la Ciudad es tuya.",type:"map",url:"http://epok.buenosaires.gob.ar/pub/mapa/sociopublico/ciudad_cercana/"}]},{title:"Explorá",order:0,category:!1,slides:[{title:"Explorá",description:"Conocé todo lo que el Ministerio de Desarrollo Urbano y Transporte está haciendo para mejorar la Ciudad. <a>Explorá todos los mapas</a>. Explorá todas las obras.",type:"image",url:"http://cdn2.buenosaires.gob.ar/desarrollourbano/sociopublico/acceso_constitucion/comuna1constitucion.jpg"}]}],angular.module("obrasMduytApp",["ngRoute","ngSanitize","slugifier","angular-flexslider","leaflet-directive","ngTable"]).config(["$routeProvider","$logProvider","$httpProvider","$locationProvider",function(a,b,c,d){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/buscador",{templateUrl:"views/buscador.html",controller:"BuscadorCtrl",controllerAs:"buscador"}).when("/obra/:id",{templateUrl:"views/obra.html",controller:"ObraCtrl",controllerAs:"obra"}).when("/entorno/:entorno",{templateUrl:"views/entorno.html",controller:"EntornoCtrl",controllerAs:"entorno"}).when("/historia",{templateUrl:"views/historia.html",controller:"HistoriaCtrl",controllerAs:"historia"}).when("/mapas",{templateUrl:"views/mapas.html",controller:"MapasCtrl",controllerAs:"mapas"}).otherwise({redirectTo:"/home"}),b.debugEnabled(!1),d.hashPrefix("")}]).service("DataService",["$http","$q","Slug","$sce",function(a,b,c,d){var e,f,g=function(a){var b={};for(var d in a)a.hasOwnProperty(d)&&(b[d.toLowerCase()]=a[d]);b.entorno_slug=b.entorno?c.slugify(b.entorno):null,b.etapa_slug=b.etapa?c.slugify(b.etapa):null,b.tipo_slug=b.tipo?c.slugify(b.tipo):null;var e=b.comuna?b.comuna.split("|"):[null];b.comuna=e[0],b.barrio=b.barrio?b.barrio.split("|"):[],b.licitacion_oferta_empresa=b.licitacion_oferta_empresa?b.licitacion_oferta_empresa:null,b.id=parseInt(b.id),b.licitacion_anio=b.licitacion_anio?parseInt(b.licitacion_anio.trim()):null,b.monto_contrato=b.monto_contrato?parseFloat(b.monto_contrato.trim()):null,b.licitacion_presupuesto_oficial=b.licitacion_presupuesto_oficial?parseFloat(b.licitacion_presupuesto_oficial.trim()):null,b.plazo_meses=b.plazo_meses?parseInt(b.plazo_meses.trim()):null,b.porcentaje_avance=b.porcentaje_avance?parseFloat(b.porcentaje_avance.trim()):null,b.hideDates="En proyecto"===b.etapa||"En licitación"===b.etapa,b.fotos=[];for(var f=1;4>=f;f++){var d="imagen_"+f;b[d]&&(b.fotos[f-1]=b[d])}return b},h=["en-proyecto","en-licitacion","en-ejecucion","finalizada"],i=function(a){var b=h.indexOf(a.etapa_slug)>-1;return b},j=function(){window.MDUYT_CONFIG||(console.warn("Archivo de configuración inexistente, utilizando configuración default de desarrollo."),window.MDUYT_CONFIG={BASE_URL:"http://api.topranking.link/",HOME_CSV:"https://goo.gl/vcb6oX",MAPAS_CSV:"https://goo.gl/YYV2E7"},window.location.href.indexOf("dist")>-1?L.Icon.Default.imagePath="/dist/images":L.Icon.Default.imagePath="images")},k=function(){j();var a=window.MDUYT_CONFIG.BASE_URL+"?source_format=csv&source="+window.MDUYT_CONFIG.HOME_CSV;return d.trustAsResourceUrl(a)},l=function(){j();var a=window.MDUYT_CONFIG.BASE_URL+"?source_format=csv&source="+window.MDUYT_CONFIG.MAPAS_CSV;return d.trustAsResourceUrl(a)};this.getById=function(a){var c,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.id===parseInt(a)}),d.resolve(c[0])}),c=d.promise,b.when(c)},this.getByEntorno=function(a){var c,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.entorno_slug===a}),d.resolve(c)}),c=d.promise,b.when(c)},this.getAll=function(){var a,c=b.defer();return this.retrieveAll().then(function(a){c.resolve(a)}),a=c.promise,b.when(a)},this.getMapas=function(){var a,c=b.defer();return this.retrieveMapas().then(function(a){c.resolve(a)}),a=c.promise,b.when(a)},this.retrieveMapas=function(){if(!f){var c=b.defer();a.jsonp(l()).then(function(a){f=a.data,c.resolve(f)},function(a){console.log("error: ",a),e=a,c.reject(a)}),f=c.promise}return b.when(f)},this.retrieveAll=function(){if(!e){var c=b.defer();a.jsonp(k()).then(function(a){e=a.data.map(g).filter(i),c.resolve(e)},function(a){e=a,c.reject(a)}),e=c.promise}return b.when(e)}}]).filter("capitalize",function(){return function(a){return a?a.charAt(0).toUpperCase()+a.substr(1).toLowerCase():""}}).filter("cleanunderscore",function(){return function(a){return a.replace(/_/g," ")}}).run(function(){}),angular.module("obrasMduytApp").directive("progressLine",function(){return{restrict:"E",replace:!0,scope:{callback:"=callback","class":"=class"},controller:["$scope","$timeout","$http",function(a,b,c){a.loading=!0;var d=function(){var b=a.obra,c=moment(b.fecha_inicio),d=moment(b.fecha_fin_inicial),e=moment(),f=d3.scale.linear().domain([0,100]).range([c.valueOf(),d.valueOf()]),g=e.valueOf(),h=parseFloat(b.porcentaje_avance);100>h&&(g=f(h));var i,j,k,l,m,i=[{label:"Category 1",value:g}],n=0,o=document.querySelectorAll(".chart")[0].clientWidth,p=55,q=5,r=0,s=d3.scale.linear().domain([c.valueOf(),d.valueOf()]).range([0,o]);d.valueOf();d3.select(".chart").html("");var k=d3.select(".chart").append("svg").attr("width",o).attr("height",p);j=k.selectAll("g").data(i).enter().append("g"),j.attr("class","bar").attr("cx",0).attr("transform",function(a,b){return"translate("+n+","+(b*(q+r)+r)+")"}),l=s,m=d3.svg.axis().scale(l).tickSize(2).orient("bottom"),j.append("rect").attr("transform","translate(0, 15)").attr("height",1).attr("width",function(a){return l(f(100))}),k.append("g").append("text").attr("class","value").attr("y",30).attr("x",0).attr("dx",0).attr("dy","0").attr("text-anchor","start").text("Inicio"),k.append("g").append("text").attr("class","value").attr("y",45).attr("x",0).attr("dx",0).attr("dy","0").attr("text-anchor","start").text(c.format("MM-YYYY")),k.append("g").append("text").attr("class","value").attr("y",30).attr("x",o).attr("dx",0).attr("dy","0").attr("text-anchor","end").text("Fin"),k.append("g").append("text").attr("class","value").attr("y",45).attr("x",o).attr("dx",0).attr("dy","0").attr("text-anchor","end").text(d.format("MM-YYYY"))},e=function(b){a.obra=b,setTimeout(d,100)};a.resizeFunction=d,a.callback(e);var f;$(window).resize(function(){clearTimeout(f),f=setTimeout(function(){a.resizeFunction&&a.resizeFunction()},500)})}],template:'<div class="chart"></div>'}}),angular.module("obrasMduytApp").directive("coloredIcons",function(){return{restrict:"E",replace:!0,scope:{callback:"=callback",scale:"=scale","class":"=class"},controller:["$scope","$element","$timeout","$http",function(a,b,c,d){a.loading=!0;a.scale;a.id="content-"+Math.floor(1e4*Math.random());var e=("."+a.id,function(c){b[0].clientWidth;setTimeout(function(){function d(a){var b=(a.percent,g*h),c=b*(a.percent/100),d=c%1;d3.selectAll("use").attr("fill",function(a,b){return c-1>a?"#f1662f":a>c-1&&c>a?(f.append("svg:stop").attr("offset",100*d+"%").attr("stop-color","#f1662f").attr("stop-opacity",1),f.append("svg:stop").attr("offset",100*d+"%").attr("stop-color","#aaa").attr("stop-opacity",1),f.append("svg:stop").attr("offset","100%").attr("stop-color","#aaa").attr("stop-opacity",1),"url(#gradient)"):"#aaa"})}d3.select(b[0]).html("");var e=d3.select(b[0]).append("svg").attr("viewBox","0 0 100 16"),f=e.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("y1","100%").attr("y2","0%").attr("spreadMethod","pad");f.append("svg:stop").attr("offset","0%").attr("stop-color","#f1662f").attr("stop-opacity",1),e.append("defs").append("g").attr("id","iconCustom").append("path").attr("d","M3.5,2H2.7C3,1.8,3.3,1.5,3.3,1.1c0-0.6-0.4-1-1-1c-0.6,0-1,0.4-1,1c0,0.4,0.2,0.7,0.6,0.9H1.1C0.7,2,0.4,2.3,0.4,2.6v1.9c0,0.3,0.3,0.6,0.6,0.6h0.2c0,0,0,0.1,0,0.1v1.9c0,0.3,0.2,0.6,0.3,0.6h1.3c0.2,0,0.3-0.3,0.3-0.6V5.3c0,0,0-0.1,0-0.1h0.2c0.3,0,0.6-0.3,0.6-0.6V2.6C4.1,2.3,3.8,2,3.5,2z"),e.append("rect").attr("width",100).attr("height",10).attr("fill","#efefef");var g=22,h=1,i=2,j=1,k=4.3,l=4.3,m=d3.range(g*h);e.append("text").attr("id","txtValue").attr("x",1).attr("y",15).attr("dy",0).text("Manzana"),e.append("text").attr("id","txtValue").attr("x",30).attr("y",15).attr("dy",0).text("Barrio"),e.append("text").attr("id","txtValue").attr("x",60).attr("y",15).attr("dy",0).text("Comuna"),e.append("text").attr("id","txtValue").attr("x",85.5).attr("y",15).attr("dy",0).text("Ciudad"),e.append("g").attr("id","pictoLayer").selectAll("use").data(m).enter().append("use").attr("xlink:href","#iconCustom").attr("id",function(a){return"icon"+a}).attr("x",function(a){var b=a%g;return i+b*l}).attr("y",function(a){var b=Math.floor(a/g);return j+b*k}).classed("iconPlain",!0);var n=1,o=1;"manoDeObra"===a.scale&&(n=20,o=c.mano_obra),"beneficiarios"===a.scale&&(n=5e4,o=c.benficiarios);var p=100*o/(n*g),q={percent:p};d(q)},300)});a.callback(e)}],template:"<div class='colored'></div>"}}),angular.module("obrasMduytApp").controller("HomeCtrl",["$scope","DataService","$filter",function(a,b,c){function d(){z.w=y.select("#home-chart-container").node().getBoundingClientRect().width,z.w=!z.svg||z.w<500?z.w-15:z.w,a.isSmallDevice=z.w<700?!0:!1,a.isSmallDevice?(z.h=z.w,z.margin=z.w/100):(z.h=3*z.w/4,z.margin=z.w/200),z.svg||(z.svg=y.select("#home-chart-container").append("svg"),z.mainGroup=z.svg.append("g").classed("main-group",!0),z.mainGroup.append("rect").attr("fill","white"),z.svg.append("g").attr("id","comunas-group"),z.svg.append("g").attr("id","map-group"),z.svg.append("g").attr("id","etapas-group"),D.group=z.svg.append("g").attr("id","bubbles-group")),z.svg.attr("width",z.w).attr("height",z.h),z.mainGroup.select("rect").attr("width",z.w).attr("height",z.h),a.showGroup()}function e(){A.w=y.select("#side-chart-container").node().getBoundingClientRect().width,A.h=300,A.margin=A.w/100,A.gap=2,A.svg||(A.svg=y.select("#side-chart-container").append("svg"),A.mainGroup=A.svg.append("g").classed("main-group",!0),A.mainGroup.append("rect").attr("fill","white")),A.scale=y.scale.linear().domain([0,a.obras.length]).range([0,A.h-(a.total_obras_by_tipo.length-1)*A.gap]),A.svg.attr("width",A.w).attr("height",A.h),A.mainGroup.select("rect").attr("width",A.w).attr("height",A.h),A.groups=A.mainGroup.selectAll("g.tipo-group").data(a.total_obras_by_tipo),A.groups.enter().append("g").attr("id",function(a){return"tipo-group-"+a.slug}).classed("tipo-group",!0).each(function(b){var c=y.select(this);c.append("rect").datum(b).classed("tipo-rect",!0).attr("fill",function(a){return E(a.tipo)}),c.append("text").datum(b).classed("tipo-text",!0).attr("fill","#000").attr("x",30).text(function(){return b.tipo}),c.append("rect").datum(b).classed("click-rect",!0).attr("fill","white").attr("fill-opacity",0).on("click",function(b){a.selectedType==b.slug?(y.selectAll("circle.obra").style("opacity",1),y.selectAll(".tipo-group text.tipo-text").style("font-size","14px"),a.selectedType=null):(y.selectAll("circle.obra").style("opacity",.3),y.selectAll("circle.obra."+b.slug).style("opacity",1),y.selectAll(".tipo-group text.tipo-text").style("font-size","14px"),y.select("#tipo-group-"+b.slug+" .tipo-text").transition().style("font-size","20px"),a.selectedType=b.slug)})}),A.groups.selectAll("rect.tipo-rect").attr("width",20).attr("height",function(a){return A.scale(a.candidad)}),A.groups.selectAll("text.tipo-text").attr("y",function(a){return A.scale(a.candidad)/2+5}),A.groups.selectAll("rect.click-rect").attr("width",A.w).attr("height",function(a){return A.scale(a.candidad)});var b=0;A.groups.transition().attr("transform",function(a){var c=b;return b=b+A.gap+A.scale(a.candidad),"translate(0,"+c+")"})}function f(){B.w=y.select("#scale-chart-container").node().getBoundingClientRect().width,B.h=300,B.margin=B.w/100,B.gap=5,B.nFormatter=function(a,b){var d,e=[{value:1e6,symbol:" millones"},{value:1e3,symbol:" mil"}],f=/\.0+$|(\.[0-9]*[1-9])0+$/;for(d=0;d<e.length;d++)if(a>=e[d].value)return c("currency")((a/e[d].value).toFixed(b).replace(f,"$1"),"$",0).replace(/\,/g,".")+e[d].symbol;return a.toFixed(b).replace(f,"$1")},B.svg||(B.svg=y.select("#scale-chart-container").append("svg"),B.mainGroup=B.svg.append("g").classed("main-group",!0),B.mainGroup.append("rect").attr("fill","white"));var a;if(D.scale){var b=D.scale.domain();D.scale.range();a=[{legend:B.nFormatter(b[1],0),radius:B.w/8},{legend:B.nFormatter((b[0]+b[1])/2,0),radius:B.w/12},{legend:B.nFormatter(b[0],0),radius:B.w/16}]}else a=[{legend:"Obra",radius:10}];B.groups=B.mainGroup.selectAll("g.legend-group").data(a),B.groups.enter().append("g").attr("id",function(a,b){return"legend-group-"+b}).classed("legend-group",!0).each(function(a){var b=y.select(this);b.append("circle").datum(a).classed("legend-circle",!0).attr("fill","#B5B5B5"),b.append("text").datum(a).classed("legend-text",!0).attr("fill","#000")}),B.groups.each(function(a){var b=y.select(this);b.select("circle").datum(a),b.select("text").datum(a)}),B.groups.exit().remove();var d=0;B.groups.transition().attr("transform",function(a){var b=d;return d+=B.gap+2*a.radius,"translate(0,"+b+")"});var e=y.max(a,function(a){return a.radius});B.groups.selectAll("circle.legend-circle").attr("cy",function(a){return a.radius}).attr("cx",function(a){return e}).attr("r",function(a){return a.radius}),B.groups.selectAll("text.legend-text").attr("text-anchor","start").attr("x",function(a){return 2*e+3}).attr("y",function(a){return a.radius+5}).style("opacity",0).text(function(a){return a.legend}).transition().style("opacity",1),B.svg.attr("width",B.w).attr("height",d),B.mainGroup.select("rect").attr("width",B.w).attr("height",d)}function g(a,b,c){var d=Math.floor(z.w/b),e=0,f=0;a.transition().duration(700).attr("transform",function(g,h){var i=e*b,j=f*c;return d-1>e?e++:a[0].length!==h+1&&(e=0,f++),"translate("+i+","+j+")"})}function h(){function b(){var b={nodes:[],links:[]},c=[],d=y.nest().key(function(a){return a.comuna}).rollup(function(a){return{candidad:a.length,hijos:y.nest().key(function(a){return a.tipo}).rollup(function(a){return{candidad:a.length,hijos:y.nest().key(function(a){return a.etapa}).rollup(function(a){return{candidad:a.length,hijos:a}}).map(a.filter(function(a){return""!=a.etapa}))}}).map(a.filter(function(a){return""!=a.tipo}))}}).map(a.obras.filter(function(a){return a.comuna}));J.each(d,function(a,b){J.each(a.hijos,function(a,d){c.push({source:b,target:d,value:a.candidad}),J.each(a.hijos,function(a,b){c.push({source:d,target:b,value:a.candidad})})})});var e={};return c.forEach(function(a){b.nodes.push({name:a.source}),b.nodes.push({name:a.target}),e[a.source+"|"+a.target]||(e[a.source+"|"+a.target]={source:a.source,target:a.target,value:0}),e[a.source+"|"+a.target].value+=a.value}),J.forOwn(e,function(a,c){b.links.push(a)}),b.nodes=y.keys(y.nest().key(function(a){return a.name}).map(b.nodes)),b.links.forEach(function(a,c){b.links[c].source=b.nodes.indexOf(b.links[c].source),b.links[c].target=b.nodes.indexOf(b.links[c].target)}),b.nodes.forEach(function(a,c){b.nodes[c]={"node:":c,name:a}}),b}C.w=y.select("#sankey-chart-container").node().getBoundingClientRect().width,C.w=!C.svg||C.w<500?C.w-15:C.w,C.h=500,C.margin=C.w/100,C.svg||(C.svg=y.select("#sankey-chart-container").append("svg"),C.mainGroup=C.svg.append("g").classed("main-group",!0),C.mainGroup.append("rect").attr("fill","white")),C.svg.attr("width",C.w).attr("height",C.h),C.mainGroup.select("rect").attr("width",C.w).attr("height",C.h),C.sankey=y.sankey().nodeWidth(20).nodePadding(2).size([C.w,C.h]),C.path=C.sankey.link(),C.graph=b(),C.sankey.nodes(C.graph.nodes).links(C.graph.links).layout(32),C.link=C.mainGroup.selectAll(".link").data(C.graph.links).enter().append("path").attr("class","link").attr("d",C.path).style("stroke-width",function(a){return Math.max(1,a.dy)}).style("stroke",function(a){return E(E.domain().indexOf(a.source.name)>-1?a.source.name:a.target.name)}).sort(function(a,b){return b.dy-a.dy}),C.link.append("title").text(function(a){var b=isNaN(a.source.name)?a.source.name:"Comuna "+a.source.name;return b+" → "+a.target.name+"\nObras: "+a.value}),C.node=C.mainGroup.selectAll(".node").data(C.graph.nodes).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),C.node.append("rect").attr("height",function(a){return a.dy}).attr("width",C.sankey.nodeWidth()).style("fill",function(a){return E.domain().indexOf(a.name)>-1?E(a.name):"#000"}).append("title").text(function(a){var b=isNaN(a.name)?a.name:"Comuna "+a.name;return b+="\nObras: "+a.value}),C.node.append("text").attr("y",function(a){return a.dy/2}).attr("x",function(a){return isNaN(a.name)?-3:3+C.sankey.nodeWidth()}).attr("text-anchor",function(a){return isNaN(a.name)?"end":"start"}).attr("dy",".35em").attr("transform",null).style("font-size",function(a){return isNaN(a.name)?"14px":"10px"}).text(function(a){return a.name}).filter(function(a){return a.x<C.width/2})}function i(){function b(){a.isSmallDevice&&z.svg.attr("height",z.w),z.mapGroup.selectAll("path.map-item").style("display","block").style("stroke-width",0).transition().duration(1e3).style("stroke-width",3).attr("d",z.mapPath).style("opacity",1)}z.mapProjection=y.geo.mercator().center([-58.43992,-34.618]).translate([z.w/2,z.h/2]).scale(190*z.w),z.mapPath=y.geo.path().projection(z.mapProjection),z.mapGroup?b():(z.mapGroup=z.svg.select("#map-group"),y.json("geo/comunas.simple.geojson",function(a){z.mapCentroids={},z.mapFeatures=a.features,J.each(z.mapFeatures,function(a){z.mapCentroids["mapa-comuna-"+a.properties.comuna]=z.mapPath.centroid(a)}),z.mapGroup.selectAll("path.map-item").data(z.mapFeatures).enter().append("path").classed("child",!0).classed("map-item",!0).attr("id",function(a){return"mapa-comuna-"+a.properties.comuna}).classed("shape",!0).on("click",k),b()}))}function j(){D.clusters={},D.clusterPoints={},D.nodesComuna=[],D.nodes=a.obras.filter(function(a){return a.lat&&a.lng}).map(function(a){var b="i"+a.id,c=5,d={cluster:b,radius:c,data:a};D.clusters[b]=d;var e=z.mapProjection([parseFloat(a.lng),parseFloat(a.lat)]);return D.clusterPoints[b]={x:e[0],y:e[1],radius:5},d}),D.scale=!1,f()}function k(b){if(a.closeTooltip(),L.node()===this)return l();L.classed("active",!1),L=y.select(this).classed("active",!0);var c=z.mapPath.bounds(b),d=c[1][0]-c[0][0],e=c[1][1]-c[0][1],f=(c[0][0]+c[1][0])/2,g=(c[0][1]+c[1][1])/2,h=.9/Math.max(d/z.w,e/z.h),i=[z.w/2-h*f,z.h/2-h*g];z.mapGroup.transition().duration(750).attr("transform","translate("+i+")scale("+h+")"),z.mapGroup.selectAll("path").transition().duration(750).style("stroke-width","1px"),D.group.transition().duration(750).attr("transform","translate("+i+")scale("+h+")")}function l(){L.classed("active",!1),L=y.select(null),z.mapGroup.transition().duration(750).attr("transform",""),z.mapGroup.selectAll("path").transition().duration(750).style("stroke-width","3px"),D.group.transition().duration(750).attr("transform","")}function m(b){var c,d,e=y.range(1,16);a.isSmallDevice?(c=z.w,d=z.w,z.svg.attr("height",e.length*z.w),z.mainGroup.select("rect").attr("height",e.length*z.w)):(c=z.h/3,d=z.w/5),z.comunasGroup||(z.comunasGroup=z.svg.select("#comunas-group"),z.comunasGroup.selectAll("g.comunas-item").data(e).enter().append("g").classed("child",!0).classed("comunas-item",!0).style("opacity",0).attr("transform",function(a,b){return"translate("+(z.w/2-d/2)+","+(z.h/2-c/2)+")"}).attr("id",function(a){return"comunas-item-"+a}).each(function(){var a=y.select(this);a.append("rect").classed("comunas-item-frame",!0).on("click",o),a.append("text").classed("comunas-item-text",!0).attr("fill","#000").text(function(a){return"Comuna "+a})})),b||z.comunasGroup.selectAll("g.comunas-item").style("display","block"),z.comunasGroup.selectAll("rect.comunas-item-frame").transition().duration(700).attr("x",z.margin).attr("y",z.margin).attr("height",c-2*z.margin).attr("width",d-2*z.margin),z.comunasGroup.selectAll("text.comunas-item-text").transition().duration(700).attr("x",15).attr("y",25),g(z.comunasGroup.selectAll("g.comunas-item").transition().duration(1e3).style("opacity",1),d,c)}function n(b){D.clusters={},D.clusterPoints={},D.nodesComuna=[];var c=b?b.replace("comunas-item-",""):!1,d=a.obras.filter(function(a){return a.comuna&&(!c||c&&a.comuna===c)}),e=Math.ceil(y.max(d,function(b){return b[a.selectedRadioDimension]})),g=Math.floor(y.min(d,function(b){return b[a.selectedRadioDimension]}));D.scale=y.scale.linear().domain([parseInt(g),parseInt(e)]).range([10,c?100:50]),f(),D.nodes=d.filter(function(a){return a.comuna&&(!c||c&&a.comuna===c)}).map(function(b){var c="c"+b.comuna,d=D.scale(b[a.selectedRadioDimension]?b[a.selectedRadioDimension]:0),e={cluster:c,radius:d?d:10,data:b};return(!D.clusters[c]||d>D.clusters[c].radius)&&(D.clusters[c]=e),e}),y.selectAll("g.comunas-item").each(function(a){var b=y.select(this),c=b.select("rect");D.clusterPoints["c"+a]={x:y.transform(b.attr("transform")).translate[0]+c.attr("width")/2,y:y.transform(b.attr("transform")).translate[1]+c.attr("height")/2,radius:20}})}function o(b){if(!a.isSmallDevice){if(a.closeTooltip(),M.node()===this)return p();M.classed("active",!1),M=y.select(this).classed("active",!0);var c=M.node().parentNode;y.selectAll("g.comunas-item").transition().style("opacity",function(){return this===c?1:0}).each("end",function(){this!==c&&y.select(this).style("display","none")}),M.transition().duration(750).attr("height",z.h-2*z.margin).attr("width",z.w-2*z.margin),y.select(c).transition().duration(750).attr("transform","translate(0,0)").each("end",function(){n(y.select(c).attr("id")),u()})}}function p(a){M.classed("active",!1),M=y.select(null),y.selectAll("g.comunas-item").style("display","block"),m(a),a||setTimeout(function(){n(),u()},2e3)}function q(b){var c,d,e=["en-proyecto","en-licitacion","en-ejecucion","finalizada"],f={"en-proyecto":"En Proyecto","en-licitacion":"En Licitación","en-ejecucion":"En Ejecución",finalizada:"Finalizada"};a.isSmallDevice?(c=z.w,d=z.w,z.svg.attr("height",e.length*z.w),z.mainGroup.select("rect").attr("height",e.length*z.w)):(c=z.h/2,d=z.w/2),z.etapasGroup||(z.etapasGroup=z.svg.select("#etapas-group"),z.etapasGroup.selectAll("g.etapas-item").data(e).enter().append("g").classed("child",!0).classed("etapas-item",!0).style("opacity",0).attr("transform",function(a,b){return"translate("+(z.w/2-d/2)+","+(z.h/2-c/2)+")"}).attr("id",function(a){return"etapas-item-"+a}).each(function(){var a=y.select(this);a.append("rect").classed("etapas-item-frame",!0).on("click",t),a.append("text").classed("etapas-item-text",!0).attr("fill","#000").text(function(a){return f[a]})})),b||z.etapasGroup.selectAll("g.etapas-item").style("display","block"),z.etapasGroup.selectAll("rect.etapas-item-frame").transition().duration(700).attr("x",z.margin).attr("y",z.margin).attr("height",c-2*z.margin).attr("width",d-2*z.margin),
z.etapasGroup.selectAll("text.etapas-item-text").transition().duration(700).attr("x",15).attr("y",25),g(z.etapasGroup.selectAll("g.etapas-item").transition().duration(1e3).style("opacity",1),d,c)}function r(b){D.clusters={},D.clusterPoints={},D.nodesComuna=[];var c=b?b.replace("etapas-item-",""):!1,d=a.obras.filter(function(a){return a.etapa&&(!c||c&&a.etapa_slug===c)}),e=Math.ceil(y.max(d,function(b){return b[a.selectedRadioDimension]})),g=Math.floor(y.min(d,function(b){return b[a.selectedRadioDimension]}));D.scale=y.scale.linear().domain([parseInt(g),parseInt(e)]).range([10,c?100:50]),f(),D.nodes=d.map(function(b){var c="e-"+b.etapa_slug,d=D.scale(b[a.selectedRadioDimension]?b[a.selectedRadioDimension]:10),e={cluster:c,radius:d?d:10,data:b};return(!D.clusters[c]||d>D.clusters[c].radius)&&(D.clusters[c]=e),e}),c?D.clusterPoints=!1:y.selectAll("g.etapas-item").each(function(a){var b=y.select(this),c=b.select("rect");D.clusterPoints["e-"+a]={x:y.transform(b.attr("transform")).translate[0]+c.attr("width")/2,y:y.transform(b.attr("transform")).translate[1]+c.attr("height")/2,radius:10}})}function s(a){N.classed("active",!1),N=y.select(null),y.selectAll("g.etapas-item").style("display","block"),q(a),a||setTimeout(function(){r(),u()},2e3)}function t(b){if(!a.isSmallDevice){if(a.closeTooltip(),N.node()===this)return s();N.classed("active",!1),N=y.select(this).classed("active",!0);var c=N.node().parentNode;y.selectAll("g.etapas-item").transition().style("opacity",function(){return this===c?1:0}).each("end",function(){this!==c&&y.select(this).style("display","none")}),N.transition().duration(750).attr("height",z.h-2*z.margin).attr("width",z.w-2*z.margin),y.select(c).transition().duration(750).attr("transform","translate(0,0)").each("end",function(){r(y.select(c).attr("id")),u()})}}function u(){D.force=y.layout.force().nodes(D.nodes).size([z.w,z.h]).gravity(0).charge(1).on("tick",v).start(),D.circles=D.group.selectAll("circle.obra").data(D.nodes),D.circles.enter().append("circle").attr("class",function(a){return"obra "+a.data.tipo_slug}).on("click",function(b){a.selectedObra=b,a.$apply(),a.isSmallDevice?a.tooltip.style("width",z.w-20+"px").transition().duration(200).style("left","10px").style("top",y.event.pageY+"px").style("opacity",1):a.tooltip.style("width","200px").transition().duration(200).style("left",y.event.pageX+"px").style("top",y.event.pageY+"px").style("opacity",1)}),D.circles.attr("id",function(a){return"e"+a.data.id}).style("fill",function(a){return E(a.data.tipo)}),D.circles.transition().style("opacity",1).attr("r",function(a){return a.radius}),D.circles.exit().remove(),D.circles.each(function(a){})}function v(a){D.circles.each(w(10*a.alpha*a.alpha)).each(x(.5)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}function w(a){return function(b){var c=D.clusters[b.cluster],d=1;if(c){c===b&&(D.clusterPoints?(c=D.clusterPoints[b.cluster],c={x:c.x,y:c.y,radius:-c.radius},d=.5*Math.sqrt(b.radius)):(c={x:z.w/2,y:z.h/2,radius:-b.radius},d=.1*Math.sqrt(b.radius)));var e=b.x-c.x,f=b.y-c.y,g=Math.sqrt(e*e+f*f),h=b.radius+c.radius;g!==h&&(g=(g-h)/g*a*d,b.x-=e*=g,b.y-=f*=g,c.x+=e,c.y+=f)}}}function x(a){var b=y.geom.quadtree(D.nodes);return function(c){var d=c.radius+2,e=c.x-d,f=c.x+d,g=c.y-d,h=c.y+d;b.visit(function(b,d,i,j,k){if(b.point&&b.point!==c){var l=c.x-b.point.x,m=c.y-b.point.y,n=Math.sqrt(l*l+m*m),o=c.radius+b.point.radius+2;o>n&&(n=(n-o)/n*a,c.x-=l*=n,c.y-=m*=n,b.point.x+=l,b.point.y+=m)}return d>f||e>j||i>h||g>k})}}var y=window.d3;a.pymChild=new window.pym.Child({polling:1e3});var z={},A={},B={},C={},D={},E=y.scale.ordinal().range(["#A5E668","#678DD8","#F94745","#EE73A7","#FF8F12","#00BDB7","#FFD500"]);a.selectedGroup="mapa",a.oldGroup="mapa",a.selectedObra=!1,a.selectedRadioDimension="monto_contrato",a.tooltip=y.select("#tooltip-home-chart");var F={comunas:m,etapas:q,mapa:i},G={comunas:n,etapas:r,mapa:j},H={comunas:p,etapas:s,mapa:l},I={comunas:!1,etapas:!1,mapa:!1},J=window._,K=0;$(window).load(function(){K=$(window).width()}),b.getAll().then(function(b){a.obras=b,a.obras_by_tipo=J.groupBy(b,"tipo"),a.tipo_keys=J.keys(a.obras_by_tipo),a.total_obras_by_tipo=J.reduce(a.obras_by_tipo,function(a,b,c){return a.push({tipo:c,slug:b[0].tipo_slug,candidad:b.length}),a},[]),e(),h(),d(),window.$(window).resize(function(){K!=$(window).width()&&(clearTimeout(a.timeoutId),a.timeoutId=setTimeout(function(){I={comunas:!1,etapas:!1,mapa:!1},e(),h(),d()},1e3))})}),a.showGroup=function(){a.oldGroup!==a.selectedGroup&&(a.closeTooltip(),H[a.oldGroup](!0),z.svg.selectAll(".child").style("opacity",0).style("display","none"),z.svg.selectAll("circle.obra").transition().style("opacity",.5),a.oldGroup=a.selectedGroup),F[a.selectedGroup]();var b=I[a.selectedGroup]||"mapa"===a.selectedGroup?100:2e3;I[a.selectedGroup]=!0,setTimeout(function(){G[a.selectedGroup](),u()},b)};var L=y.select(null),M=y.select(null),N=y.select(null);a.closeTooltip=function(){a.tooltip.transition().duration(200).style("opacity",0).style("top","-100px").style("left","-100px")}}]),angular.module("obrasMduytApp").controller("ObraCtrl",["$scope","DataService","$routeParams",function(a,b,c){a.pymChild=new window.pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.obraId=c.id;var d={url:"//tiles1.usig.buenosaires.gob.ar/mapcache/tms/1.0.0/amba_con_transporte_3857@GoogleMapsCompatible/{z}/{x}/{y}.png",format:"tms",builder:"tms",baseLayer:!0,options:{maxZoom:18,minZoom:9,attribution:'USIG (<a href="http://www.buenosaires.gob.ar" target="_blank">GCBA</a>), © <a href="http://www.openstreetmap.org/copyright/en" target="_blank">OpenStreetMap</a> (ODbL)',tms:!0}};a.titles=d,angular.extend(a,{markers:{},center:{lat:-34.604,lng:-58.382,zoom:15},tiles:d,defaults:{scrollWheelZoom:!1}}),a.mainCallback=function(b){a.drawLineOnObraLoaded=b},a.drawFirstColored=function(b){a.firstColoredLoaded=b},a.drawSecondColored=function(b){a.secondColoredLoaded=b},b.getById(c.id).then(function(b){a.obra=b,!b.hideDates&&a.drawLineOnObraLoaded&&a.drawLineOnObraLoaded(b),b.beneficiarios&&a.firstColoredLoaded&&a.firstColoredLoaded(b),b.mano_obra&&a.secondColoredLoaded&&a.secondColoredLoaded(b),a.slides=b.fotos,angular.extend(a,{center:{lat:parseFloat(b.lat),lng:parseFloat(b.lng),zoom:15},markers:{m1:{lat:parseFloat(b.lat),lng:parseFloat(b.lng),focus:!0,message:b.nombre}}}),a.center.lat=parseFloat(b.lat),a.center.lng=parseFloat(b.lng);({starting_time:b.fecha_inicio,ending_time:b.fecha_fin_inicial})})}]),angular.module("obrasMduytApp").controller("EntornoCtrl",["$scope","DataService","$routeParams","leafletData","$timeout",function(a,b,c,d,e){a.pymChild=new window.pym.Child({polling:1e3}),a.pymChild.sendHeight();var f={url:"//tiles1.usig.buenosaires.gob.ar/mapcache/tms/1.0.0/amba_con_transporte_3857@GoogleMapsCompatible/{z}/{x}/{y}.png",format:"tms",builder:"tms",baseLayer:!0,options:{maxZoom:18,minZoom:9,attribution:'USIG (<a href="http://www.buenosaires.gob.ar" target="_blank">GCBA</a>), © <a href="http://www.openstreetmap.org/copyright/en" target="_blank">OpenStreetMap</a> (ODbL)',tms:!0}};a.titles=f,angular.extend(a,{markers:{},center:{lat:-34.604,lng:-58.382,zoom:15},tiles:f,defaults:{scrollWheelZoom:!1}}),b.getByEntorno(c.entorno).then(function(b){a.entorno=c.entorno,a.obras=b;for(var f={},g=[],h=0;h<b.length;h++){var i=b[h];if(i.lat&&i.lng){var j={lat:parseFloat(i.lat),lng:parseFloat(i.lng),focus:!0,message:i.nombre};f["m"+h]=j,g.push(L.marker([j.lat,j.lng]))}}var k=new L.featureGroup(g);angular.extend(a,{markers:f}),e(function(){d.getMap().then(function(a){a.fitBounds(k.getBounds(),{padding:[50,50]})})},1e3)})}]),angular.module("obrasMduytApp").controller("BuscadorCtrl",["$scope","DataService","$routeParams","NgTableParams","$filter","$sce","ngTableEventsChannel",function(a,b,c,d,e,f,g){a.pymChild=new window.pym.Child({polling:1e3}),a.pymChild.sendHeight(),b.getAll().then(function(b){function c(a,b){return b[this.field]}function e(a,b){var c=b[this.field],d="";return c&&""!=c&&(d="<a href='"+c+"' class='btn btn-default btn-xs btn-block' target='_blank'>Más información</a>"),f.trustAsHtml(d)}function h(b){a.results=b.data}function i(){$('[ng-table-pagination="params"]').appendTo("#footer")}function j(b){a.cols.forEach(function(a){m[b].indexOf(a.field)>-1?a.show=!0:a.show=!1}),a.$apply()}function k(){var a=d3.select("#buscador-table").node().getBoundingClientRect().width;a>700?j("lg"):700>=a&&a>650?j("md"):650>=a&&a>600?j("sm"):600>=a&&j("xs")}var l={comunas:d3.keys(d3.nest().key(function(a){return a.comuna}).map(b.filter(function(a){return null!==a.comuna}))).map(function(a){return{id:a.trim(),title:"Comuna "+a}}),etapas:d3.keys(d3.nest().key(function(a){return a.etapa}).map(b)).map(function(a){return{id:a,title:a}}),tipos:d3.keys(d3.nest().key(function(a){return a.tipo}).map(b)).map(function(a){return{id:a,title:a}})};l.comunas.unshift({id:"",title:"TODAS"}),l.etapas.unshift({id:"",title:"TODAS"}),l.tipos.unshift({id:"",title:"TODOS"}),a.cols=[{field:"comuna",title:"Comuna",filter:{comuna:"select"},filterData:l.comunas,show:!0,getValue:c},{field:"nombre",title:"Nombre",filter:{nombre:"text"},show:!0,"class":"lupita",getValue:c},{field:"area_responsable",title:"Área",filter:{area_responsable:"text"},show:!0,"class":"lupita",getValue:c},{field:"licitacion_oferta_empresa",title:"Empresa",filter:{licitacion_oferta_empresa:"text"},show:!0,"class":"lupita",getValue:c},{field:"etapa",title:"Etapa",filter:{etapa:"select"},filterData:l.etapas,show:!0,getValue:c},{field:"tipo",title:"Tipo",filter:{tipo:"select"},filterData:l.tipos,show:!0,getValue:c},{field:"link_interno",title:"",filter:!1,show:!0,getValue:e}],g.onAfterCreated(i,a),g.onAfterReloadData(h,a),a.tableParams=new d({sorting:{comuna:"asc"},filter:{comuna:"",etapa:"",tipo:""},page:1,count:10},{dataset:b,counts:[10,25,50]});var m={lg:["comuna","nombre","area_responsable","licitacion_empresa","etapa","monto_contrato","link_interno"],md:["comuna","nombre","licitacion_empresa","etapa","monto_contrato","link_interno"],sm:["comuna","nombre","etapa","monto_contrato","link_interno"],xs:["nombre","etapa","monto_contrato","link_interno"]};a.timeoutId,window.$(window).resize(function(){clearTimeout(a.timeoutId),a.timeoutId=setTimeout(function(){k()},1e3)})})}]),angular.module("obrasMduytApp").filter("ByCategoryFilter",function(){return function(a,b,c){var d=[];return a&&b&&angular.forEach(b.filter(function(a){return a.active}),function(b){d=d.concat(a.filter(function(a){return a.categoria==b.name&&(""==c||a.descripcion.indexOf(c)>-1)}))}),d}}).controller("MapasCtrl",["$scope","DataService","$http","leafletData","$sce","$window",function(a,b,c,d,e,f){a.pymChild=new window.pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.loading=!0,a.loadingMap=!1,a.filterTerm="";var g={url:"http://tiles1.usig.buenosaires.gob.ar/mapcache/tms/1.0.0/amba_con_transporte_3857@GoogleMapsCompatible/{z}/{x}/{y}.png",format:"tms",builder:"tms",baseLayer:!0,options:{maxZoom:18,minZoom:9,attribution:'USIG (<a href="http://www.buenosaires.gob.ar" target="_blank">GCBA</a>), © <a href="http://www.openstreetmap.org/copyright/en" target="_blank">OpenStreetMap</a> (ODbL)',tms:!0}};angular.extend(a,{markers:{},tiles:g,center:{lat:-34.604,lng:-58.43,zoom:12},defaults:{scrollWheelZoom:!1}}),a.data={},b.getMapas().then(function(b){console.log(b),a.rawdata=b,a.maps=b,a.nested=d3.nest().key(function(a){return a.categoria}).map(b.map(function(a){return a.preview=a.tiles.replace("{z}","13").replace("{x}","2767").replace("{y}","3255"),a})),a.cats=_.keys(a.nested).map(function(a){return{name:a,active:!0}}),a.loading=!1}),a.toggleFilter=function(a){a.active=!a.active},a.selectMap=function(b){g.url=b.tiles,a.tiles=g,a.currentMap=b},a.unselectMap=function(b){a.currentMap=!1},a.clearFilter=function(){_.forEach(a.cats,function(a){a.active=!0}),a.filterTerm="",a.unselectMap()}}]),angular.module("obrasMduytApp").controller("HistoriaCtrl",["$scope","DataService","$routeParams","leafletData","$timeout",function(a,b,c,d,e){a.pymChild=new window.pym.Child({polling:1e3}),a.pymChild.sendHeight(),console.log(window.SLIDES_DATA),a.SLIDES_DATA=window.SLIDES_DATA,a.historyIndex=-1,a.slideIndex=0,a.mouseoverVariation=function(b){a.history.pic=b},a.mouseoutVariation=function(){a.history.pic="main"},a.nextHistory=function(){a.historyIndex=a.SLIDES_DATA[a.historyIndex+1]?a.historyIndex+1:0,a.renderHistory()},a.prevHistory=function(){a.historyIndex=0==a.historyIndex?a.SLIDES_DATA.length-1:a.historyIndex-1,a.renderHistory()},a.renderHistory=function(){a.history=a.SLIDES_DATA[a.historyIndex],a.history.pic="main",a.slideIndex=0,$("#history-carousel").carousel({interval:!1}).off("slid.bs.carousel").on("slid.bs.carousel",function(b){var c=$(b.relatedTarget).attr("id").split("-")[1];a.slideIndex=parseInt(c),a.$apply()})},a.selectCategory=function(b){var c=_.findIndex(a.SLIDES_DATA,function(a){return a.category==b});c>0&&(a.historyIndex=c,a.renderHistory())},a.nextHistory()}]),angular.module("obrasMduytApp").run(["$templateCache",function(a){"use strict";a.put("views/buscador.html",'<div class="row"> <table id="buscador-table" ng-table-dynamic="tableParams with cols" class="table table-responsive"> <tr ng-repeat="row in $data"> </tr> </table> </div> <div class="row"> <h2 ng-show="results.length==0" class="text-center">No hay resultados para los filtros aplicados</h2> <div class="col-sm-12 well resultado-buscador" ng-repeat="o in results"> <div class="row"> <div class="col-sm-3"> <img ng-show="o.imagen_1" ng-src="{{o.imagen_1}}" class="img-responsive"> <img ng-hide="o.imagen_1" ng-src="http://placehold.it/400x300" class="img-responsive"> </div> <div class="col-sm-9"> <div class="row"> <div class="col-sm-6"> <span class="title">Obra:</span> <span class="desc">{{o.nombre}}</span> </div> <div class="col-sm-6"> <span class="title">Empresa:</span> <span class="desc">{{o.licitacion_oferta_empresa}}</span> </div> </div> <div class="row"> <div class="col-sm-12"> <span class="title">Descripción:</span> <span class="desc">{{o.descripcion}}</span> </div> </div> <div class="row"> <div class="col-sm-2"> <span class="title">Área:</span> <span class="desc">{{o.area_responsable}}</span> </div> <div class="col-sm-2"> <span class="title">Tipo:</span> <span class="desc">{{o.tipo}}</span> </div> <div class="col-sm-2"> <span class="title">Comuna:</span> <span class="desc">Comuna {{o.comuna}}</span> </div> <div class="col-sm-2"> <span class="title">Etapa:</span> <span class="desc">{{o.etapa}}</span> </div> <div class="col-sm-3 col-sm-offset-1"> <a ng-href="{{o.data.link_interno}}" class="btn btn-default btn-block">Más información</a> </div> </div> </div> </div> </div> </div> <div class="row"> <div id="footer" class="col-sm-12"> </div> </div>'),a.put("views/entorno.html",'<div class="row"> <div class="col-md-12"> <h2>Entorno: {{obras[0].entorno}}</h2> <div ng-repeat="obra in obras"> <!-- Obra: {{$index+1}} -> {{obra}} --> <div ng-include="\'views/includes/obra-detail.html\'"></div> </div> </div> </div> <div class="row"> <div class="col-md-12"> <h4> Ubicación en el Mapa </h4> <leaflet center="center" tiles="tiles" markers="markers" defaults="defaults" width="100%" height="350px"></leaflet> </div> </div>'),a.put("views/historia.html",'<div id="historia-container" class="row"> <div class="buttons-container-categories"> <div class="btn-group btn-group-header" ng-class="{categorySelected:(history.category)}" role="group"> <div class="btn-group btn-header" role="group" ng-class="{unselected: (history.category && history.category!=\'verde\')}"> <button id="verde" type="button" class="btn btn-default" ng-click="selectCategory(\'verde\')">Verde<span ng-show="(history.category && history.category==\'verde\')">: {{history.title}}</span></button> </div> <div class="btn-group btn-header" role="group" ng-class="{unselected: (history.category && history.category!=\'integrada\')}"> <button id="integrada" type="button" class="btn btn-default" ng-click="selectCategory(\'integrada\')">Integrada<span ng-show="(history.category && history.category==\'integrada\')">: {{history.title}}</span></button> </div> <div class="btn-group btn-header" role="group" ng-class="{unselected: (history.category && history.category!=\'equilibrada\')}"> <button id="equilibrada" type="button" class="btn btn-default" ng-click="selectCategory(\'equilibrada\')">Equilibrada<span ng-show="(history.category && history.category==\'equilibrada\')">: {{history.title}}</span></button> </div> <div class="btn-group btn-header" role="group" ng-class="{unselected: (history.category && history.category!=\'cercana\')}"> <button id="cercana" type="button" class="btn btn-default" ng-click="selectCategory(\'cercana\')">Cercana<span ng-show="(history.category && history.category==\'cercana\')">: {{history.title}}</span></button> </div> <div class="btn-group btn-header" role="group" ng-class="{unselected: (history.category && history.category!=\'atractiva\')}"> <button id="atractiva" type="button" class="btn btn-default" ng-click="selectCategory(\'atractiva\')">Atractiva<span ng-show="(history.category && history.category==\'atractiva\')">: {{history.title}}</span></button> </div> </div> </div> <div id="history-carousel" class="carousel slide"> <!-- Wrapper for slides --> <div class="carousel-inner" role="listbox"> <div id="item-{{key}}" ng-repeat="(key, h) in history.slides" class="item" ng-class="{active:(key==slideIndex)}"> <div class="row embed-responsive embed-responsive-16by9"> <img ng-show="history.pic == \'main\'" class="img-responsive embed-responsive-item" ng-src="{{h.url}}"> <img ng-show="history.pic == imgkey" ng-repeat="(imgkey, v) in h.variations" class="img-responsive embed-responsive-item" ng-src="{{v.url}}"> </div> <div class="container-fluid"> <div class="row"> <div class="col-md-12"> <p> <span ng-show="h.variations && h.variations.length>0">VER: </span> <span ng-repeat="(imgkey, v) in h.variations" class="label label-orange" ng-mouseover="mouseoverVariation(imgkey)" ng-mouseout="mouseoutVariation()">{{v.title}}</span> </p> <h2> {{h.title}} <ol ng-show="history.slides.length>1" class="carousel-indicators"> <li data-target="#history-carousel" ng-repeat="(key, h) in history.slides" data-slide-to="{{key}}" ng-class="{active:(key==slideIndex)}"></li> </ol> </h2> <p>{{h.description}}</p> </div> </div> <div class="row"> <div class="col-md-12"> <a ng-show="(historyIndex>0) && (slideIndex==0)" class="btn btn-link btn-orange" ng-click="prevHistory()"><span class="glyphicon glyphicon-chevron-left"></span> Historia anterior</a> <a ng-show="(slideIndex!=0)" class="btn btn-link btn-orange" data-target="#history-carousel" role="button" data-slide="prev"><span class="glyphicon glyphicon-chevron-left"></span> Anterior</a> <a ng-show="(history.slides[slideIndex+1])" class="btn btn-link btn-orange" data-target="#history-carousel" role="button" data-slide="next">Continuar <span class="glyphicon glyphicon-chevron-right"></span></a> <a ng-show="(SLIDES_DATA[historyIndex+1]) && !history.slides[slideIndex+1]" class="btn btn-link btn-orange" ng-click="nextHistory()">Próxima historia <span class="glyphicon glyphicon-chevron-right"></span></a> </div> </div> </div> </div> </div> </div> </div>'),a.put("views/home.html",'<div class="row"> <div class="col-sm-12"> <h4>Explorador de obras del Ministerio de Desarrollo Urbano y Transporte</h4> </div> </div> <div class="row"> <div class="col-md-6"> <form class="form-inline"> <div class="form-group"> <label for="agrupar" class="pull-left label-nav">Probá diferentes formas de agrupar las obras:</label> <div class="dropdown pull-left"> <button class="btn btn-link btn-home dropdown-toggle" type="button" id="agrupar" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"> {{selectedGroup | cleanunderscore}} <span class="caret"></span> </button> <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"> <li><a ng-click="selectedGroup=\'comunas\';showGroup();">Comunas</a></li> <li><a ng-click="selectedGroup=\'etapas\';showGroup();">Etapa</a></li> <li><a ng-click="selectedGroup=\'mapa\';showGroup();">Mapa</a></li> </ul> </div> </div> </form> </div> </div> <div class="row"> <div class="col-sm-10"> <div class="row"> <div class="col-sm-12"> <div id="home-chart-container"></div> </div> </div> </div> <div class="col-sm-2"> <div class="row"> <div class="col-sm-12 col-xs-6"> <h4>Tipos de obra</h4> <div id="side-chart-container"></div> <hr> </div> <div ng-show="selectedGroup!=\'mapa\'" class="col-sm-12 col-xs-6"> <h4>Monto total</h4> <div id="scale-chart-container"></div> </div> </div> </div> </div> <div class="row"> <div class="col-md-12"> <h4>Obras para una Ciudad a tu medida</h4> <p>En un solo vistazo, conocé qué estamos haciendo para mejorar la Ciudad.</p> </div> <div class="col-xs-4"> Dónde: Comunas </div> <div class="col-xs-4 text-center"> Qué hacemos: Tipos de obras </div> <div class="col-xs-4 text-right"> Cómo vamos: Etapas </div> </div> <div class="row"> <div class="col-md-12"> <div id="sankey-chart-container"></div> </div> </div> <!-- Tooltip OBRAS --> <div id="tooltip-home-chart"> <button type="button" class="close pull-right" ng-click="closeTooltip()">&times;</button> <span class="title">Obra:</span> <span class="desc">{{selectedObra.data.nombre}}</span> <span class="title">Tipo:</span> <span class="desc">{{selectedObra.data.tipo}}</span> <span class="title">Estado:</span> <span class="desc">{{selectedObra.data.etapa}}</span> <a ng-href="{{selectedObra.data.link_interno}}" class="btn btn-default btn-xs btn-block">Más información</a> </div>'),a.put("views/includes/obra-detail.html",'<div class="row obra"> <div class="col-md-12"> <h3>Obra: {{obra.nombre}}</h3> <div class="row"> <div class="col-md-8"> <img class="img-responsive" ng-src="{{obra.fotos[0]}}"> <p> {{obra.descripcion}} </p> </div> <div class="col-md-3 ficha-tecnica"> <h4> Ficha técnica</h4> <div class="etapa"> <div class="row"> <div class="col-md-2"> <p>Etapa:</p> </div> <div class="col-md-10"> <p><strong>{{obra.etapa}}</strong> </p> </div> </div> <div class="row"> <div class="col-md-2"> <p> </p> </div> <div class="col-md-10"> <p> <small> {{obra.etapa_detalle}}</small> </p> </div> </div> </div> <div> <p> Tipo de obra: <strong>{{obra.tipo}}</strong> </p> </div> <p> Área responsable: <strong> {{obra.area_responsable}}</strong></p> <p ng-show="obra.licitacion_oferta_empresa"> Empresa: <strong> {{obra.licitacion_oferta_empresa}}</strong></p> <p> Estado: </p> <div class="progress"> <div class="progress-bar bg-color-{{obra.slug}}" role="progressbar" ng-style="{ \'width\': obra.porcentaje_avance + \'%\' }"> <div class="progressbar-w" ng-show="!obra.porcentaje_avance"><p></p> </div> <span class="progressbar-w" ng-hide="obra.porcentaje_avance<22 || !obra.porcentaje_avance"> </span> </div> <div class="progress-w" ng-show="obra.porcentaje_avance<22" ng-style="{ \'width\': (100 - obra.porcentaje_avance) + \'%\' }"></div> </div> <div class="row fechas" ng-show="obra.fecha_inicio"> <div class="col-md-6"> <p class="up"> Inicio</p> <p> {{obra.fecha_inicio}} </p> </div> <div class="col-md-6 right"> <p class="up"> Fin </p> <p> {{obra.fecha_fin_inicial}} </p> </div> </div> <p ng-if="obra.plazo_meses"> Plazo total: <strong> {{obra.plazo_meses}} meses </strong> </p> <p ng-if="obra.benficiarios"> Cantidad de Beneficiaros: <strong> {{obra.benficiarios}}<small> personas</small> </strong></p> <p ng-if="obra.mano_obra"> Mano de Obra: <strong> {{obra.mano_obra}} <small>personas</small> </strong> </p> <p ng-if="obra.monto_contrato"> Monto Contrato: <strong> {{obra.monto_contrato | currency}} </strong> </p> <p ng-if="obra.licitacion_presupuesto_oficial"> Monto Actualizado: <strong> {{obra.licitacion_presupuesto_oficial | currency}} </strong> </p> <p ng-if="obra.pliego_descarga"> <a ng-href="{{obra.pliego_descarga}}"><i class="detalle-frame-icon glyphicon glyphicon glyphicon-download-alt"> </i> Ver Pliego </a> </p> </div> </div> </div> </div>'),a.put("views/mapas.html",'<div id="explorador-mapas-container" ng-cloak ng-show="!loading"> <div class="row"> <div class="form-group col-md-8"> <input type="text" class="form-control" ng-model="filterTerm" placeholder="Buscar por palabras clave"> </div> <div class="col-md-4"> <button type="submit" class="btn btn-link btn-orange" ng-click="clearFilter()">Limpiar filtros</button> </div> </div> <div class="row"> <div class="col-md-12"> <div class="buttons-container-categories"> <div class="btn-group btn-group-header" role="group"> <div class="btn-group btn-header" role="group" ng-class="{unselected: !(c.active)}" ng-repeat="c in cats"> <button id="{{c.name}}" type="button" class="btn btn-default" ng-click="toggleFilter(c)">Ciudad {{c.name}}</button> </div> </div> </div> </div> </div> <div ng-show="currentMap" class="row obra"> <div class="col-md-12"> <div class="map-item"> <div class="map-item-text"> <h3>{{currentMap.nombre}} <small class="bg-{{currentMap.categoria}} label">Ciudad {{currentMap.categoria}} <span ng-show="loadingMap"> - Cargando mapa...</span></small><a class="btn btn-link pull-right btn-orange" ng-click="unselectMap()">Cerrar</a></h3> <p class="lead">{{currentMap.descripcion}}</p> </div> <leaflet center="center" tiles="tiles" markers="markers" defaults="defaults" width="100%" height="500px"></leaflet> </div> </div> </div> <hr> <div class="row obra"> <div class="col-md-6" ng-repeat="m in maps|ByCategoryFilter:cats:filterTerm"> <div class="map-item"> <div class="row map-item-row"> <div class="col-sm-4"> <div class="map-item-preview" ng-style="{\'background-image\':\'url(\'+m.preview+\')\'}"></div> </div> <div class="map-item-text col-sm-8"> <h4>{{m.nombre}} <small class="bg-{{m.categoria}} label">Ciudad {{m.categoria}}</small></h4> <p>{{m.descripcion}}</p> <p class="text-right"> <a ng-show="m.link_historia" class="btn btn-link btn-orange">Ver historia</a><a class="btn btn-link btn-orange" ng-click="selectMap(m)">Ver mapa</a></p> </div> </div> </div> </div> </div> </div> <div ng-show="loading"> <h2>Cargando mapas ...</h2> </div>'),a.put("views/obra.html",'<div class="row obra"> <div class="col-md-12"> <h3>{{obra.nombre}}</h3> <div class="row"> <div class="col-md-8"> <flex-slider slide="s in slides" animation="slide" control-nav="thumbnails"> <li data-thumb="{{s}}"> <img ng-src="{{s}}"> </li> </flex-slider> <p> {{obra.descripcion}} </p> </div> <div class="col-md-3 ficha-tecnica"> <h4> Ficha técnica</h4> <div class="etapa"> <div class="row"> <div class="col-md-2"> <p>Etapa:</p> </div> <div class="col-md-10"> <p><strong>{{obra.etapa}}</strong> </p> </div> </div> <div class="row"> <div class="col-md-2"> <p> </p> </div> <div class="col-md-10"> <p> <small> {{obra.etapa_detalle}}</small> </p> </div> </div> </div> <div> <p> Tipo de obra: <strong>{{obra.tipo}}</strong> </p> </div> <p> Área responsable: <strong> {{obra.area_responsable}}</strong></p> <p ng-show="obra.licitacion_oferta_empresa"> Empresa: <strong> {{obra.licitacion_oferta_empresa}}</strong></p> <p> Estado: </p> <div class="progress"> <div class="progress-bar bg-color-{{obra.slug}}" role="progressbar" ng-style="{ \'width\': obra.porcentaje_avance + \'%\' }"> <div class="progressbar-w" ng-show="!obra.porcentaje_avance"><p></p> </div> <span class="progressbar-w" ng-hide="obra.porcentaje_avance<22 || !obra.porcentaje_avance"> </span> </div> <div class="progress-w" ng-show="obra.porcentaje_avance<22" ng-style="{ \'width\': (100 - obra.porcentaje_avance) + \'%\' }"></div> </div> <div ng-if="!obra.hideDates" class="row fechas" ng-show="obra.fecha_inicio"> <div class="col-md-12"> <progress-line callback="mainCallback"> </progress-line> </div> </div> <p ng-if="obra.plazo_meses"> Plazo total: <strong> {{obra.plazo_meses}} meses </strong> </p> <p ng-if="obra.hideDates && obra.licitacion_anio"> Año de licitación: <strong> {{obra.licitacion_anio}} </strong> </p>  <p ng-if="obra.beneficiarios"> Cantidad de Beneficiaros: <strong> {{obra.benficiarios}}<small> personas</small> </strong></p> <colored-icons scale="\'beneficiarios\'" callback="drawFirstColored"></colored-icons> <p ng-if="obra.mano_obra"> Mano de Obra: <strong> {{obra.mano_obra}} <small>personas</small> </strong> </p> <colored-icons scale="\'manoDeObra\'" callback="drawSecondColored"></colored-icons> <p ng-if="obra.monto_contrato"> Monto Contrato: <strong> {{obra.monto_contrato | currency}} </strong> </p> <p ng-if="obra.licitacion_presupuesto_oficial"> Monto Actualizado: <strong> {{obra.licitacion_presupuesto_oficial | currency}} </strong> </p> <p ng-if="obra.pliego_descarga"> <a ng-href="{{obra.pliego_descarga}}"><i class="detalle-frame-icon glyphicon glyphicon glyphicon-download-alt"> </i> Ver Pliego </a> </p> </div> </div> </div> </div> <div class="row"> <div class="col-md-12"> <h4> Ubicación de obra </h4> <leaflet center="center" tiles="tiles" markers="markers" defaults="defaults" width="100%" height="350px"></leaflet> </div> </div>')}]);