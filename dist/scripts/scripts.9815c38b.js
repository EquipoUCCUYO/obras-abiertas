"use strict";$.urlParam=function(a,b){var c=new RegExp("[?&]"+b+"=([^&#]*)").exec(a);return null===c?null:c[1]||0},angular.module("obrasMduytApp",["ngRoute","ngSanitize","slugifier","slick","leaflet-directive"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/obra/:id",{templateUrl:"views/obra.html",controller:"ObraCtrl",controllerAs:"obra"}).when("/entorno/:entorno",{templateUrl:"views/entorno.html",controller:"EntornoCtrl",controllerAs:"entorno"}).otherwise({redirectTo:"/home"})}]).service("DataService",["$http","$q","Slug",function(a,b,c){var d=void 0,e=function(a){return a.entorno_slug=a.entorno?c.slugify(a.entorno):null,a.tipo=a.tipo?a.tipo.split("|"):[],a.comuna=a.comuna?a.comuna.split("|"):[],a.barrio=a.barrio?a.barrio.split("|"):[],a.licitacion_oferta_empresas=a.licitacion_oferta_empresas?a.licitacion_oferta_empresas.split("|"):[],a.id=parseInt(a.id),a.licitacion_anio=a.licitacion_anio?parseInt(a.licitacion_anio):null,a.monto_contrato=a.monto_contrato?parseFloat(a.monto_contrato):null,a.licitacion_presupuesto_oficial=a.licitacion_presupuesto_oficial?parseFloat(a.licitacion_presupuesto_oficial):null,a.plazo_meses=a.plazo_meses?parseInt(a.plazo_meses):null,a.porcentaje_avance=a.porcentaje_avance?parseFloat(a.porcentaje_avance):null,a},f=function(){return window.MDUYT_CONFIG||(console.error("Archivo de configuración inexistente, utilizando configuración default de desarrollo."),window.MDUYT_CONFIG={BASE_URL:"http://api.topranking.link/",HOME_CSV:"https://goo.gl/vcb6oX"}),window.MDUYT_CONFIG.BASE_URL+"?source_format=csv&source="+window.MDUYT_CONFIG.HOME_CSV+"&callback=JSON_CALLBACK"};this.getById=function(a){var c=void 0,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.id==parseInt(a)}),d.resolve(c[0])}),c=d.promise,b.when(c)},this.getByEntorno=function(a){var c=void 0,d=b.defer();return this.retrieveAll().then(function(b){c=b.filter(function(b){return b.entorno_slug==a}),d.resolve(c)}),c=d.promise,b.when(c)},this.getAll=function(){var a=void 0,c=b.defer();return this.retrieveAll().then(function(a){c.resolve(a)}),a=c.promise,b.when(a)},this.retrieveAll=function(){if(!d){var c=b.defer();a.jsonp(f()).then(function(a){d=a.data.map(e),c.resolve(d)},function(a){d=a,c.reject(a)}),d=c.promise}return b.when(d)}}]).run(["$rootScope","$interval",function(a,b){}]),angular.module("obrasMduytApp").controller("HomeCtrl",["$scope","DataService",function(a,b){function c(){o.w=d3.select("#home-chart-container").node().getBoundingClientRect().width,o.w=!o.svg||o.w<500?o.w-15:o.w,a.isSmallDevice=o.w<500?!0:!1,a.isSmallDevice?(o.h=o.w,o.margin=o.w/100):(o.h=3*o.w/4,o.margin=o.w/200),o.svg||(o.svg=d3.select("#home-chart-container").append("svg"),o.mainGroup=o.svg.append("g").classed("main-group",!0),o.mainGroup.append("rect").attr("fill","white"),o.svg.append("g").attr("id","comunas-group"),o.svg.append("g").attr("id","map-group"),o.svg.append("g").attr("id","etapas-group"),p.group=o.svg.append("g").attr("id","bubbles-group")),o.svg.attr("width",o.w).attr("height",o.h),o.mainGroup.select("rect").attr("width",o.w).attr("height",o.h),a.showGroup(a.selectedGroup)}function d(){function b(){a.isSmallDevice&&o.svg.attr("height",o.w),o.mapGroup.selectAll("path.map-item").transition().attr("d",o.mapPath).style("opacity",1)}o.mapProjection=d3.geo.mercator().center([-58.43992,-34.618]).translate([o.w/2,o.h/2]).scale(190*o.w),o.mapPath=d3.geo.path().projection(o.mapProjection),o.mapGroup?b():(o.mapGroup=o.svg.select("#map-group"),d3.json("geo/comunas.simple.geojson",function(a){o.mapFeatures=a.features,o.mapGroup.selectAll("path.map-item").data(o.mapFeatures).enter().append("path").classed("child",!0).classed("map-item",!0).attr("id",function(a){return a.id}).classed("shape",!0),b()}))}function e(){var b=d3.range(1,16);if(o.comunasGroup||(o.comunasGroup=o.svg.select("#comunas-group"),o.comunasGroup.selectAll("g.comunas-item").data(b).enter().append("g").classed("child",!0).classed("comunas-item",!0).attr("id",function(a){return"comunas-item-"+a}).each(function(a){var b=d3.select(this);b.append("rect").classed("comunas-item-frame",!0).attr("fill","#dedede"),b.append("text").classed("comunas-item-text",!0).attr("fill","#000").text(function(a){return"Comuna "+a})})),a.isSmallDevice){var c=o.w,d=o.w;o.svg.attr("height",b.length*o.w),o.mainGroup.select("rect").attr("height",b.length*o.w)}else var c=o.h/3,d=o.w/5;o.comunasGroup.selectAll("rect.comunas-item-frame").transition().attr("x",o.margin).attr("y",o.margin).attr("height",c-2*o.margin).attr("width",d-2*o.margin),o.comunasGroup.selectAll("text.comunas-item-text").transition().attr("x",15).attr("y",25),g(o.comunasGroup.selectAll("g.comunas-item").transition().style("opacity",1),d,c)}function f(){var b=d3.range(1,5);if(o.etapasGroup||(o.etapasGroup=o.svg.select("#etapas-group"),o.etapasGroup.selectAll("g.etapas-item").data(b).enter().append("g").classed("child",!0).classed("etapas-item",!0).attr("id",function(a){return"etapas-item-"+a}).each(function(a){var b=d3.select(this);b.append("rect").classed("etapas-item-frame",!0).attr("fill","#dedede"),b.append("text").classed("etapas-item-text",!0).attr("fill","#000").text(function(a){return"Etapa "+a})})),a.isSmallDevice){var c=o.w,d=o.w;o.svg.attr("height",b.length*o.w),o.mainGroup.select("rect").attr("height",b.length*o.w)}else var c=o.h/2,d=o.w/2;o.etapasGroup.selectAll("rect.etapas-item-frame").transition().attr("x",o.margin).attr("y",o.margin).attr("height",c-2*o.margin).attr("width",d-2*o.margin),o.etapasGroup.selectAll("text.etapas-item-text").transition().attr("x",15).attr("y",25),g(o.etapasGroup.selectAll("g.etapas-item").transition().style("opacity",1),d,c)}function g(a,b,c){var d=Math.floor(o.w/b),e=0,f=0;a.transition().duration(1e3).attr("transform",function(g,h){var i=e*b,j=f*c;return d-1>e?e++:a[0].length!==h+1&&(e=0,f++),"translate("+i+","+j+")"})}function h(){p.clusters={},p.clusterPoints={},p.nodes=a.obras.filter(function(a){return a.comuna[0]}).map(function(a){var b="c"+a.comuna[0],c=10,a={cluster:b,radius:c,data:a};return(!p.clusters[b]||c>p.clusters[b].radius)&&(p.clusters[b]=a),a}),d3.selectAll("g.comunas-item").each(function(a){var b=d3.select(this),c=b.select("rect");p.clusterPoints["c"+a]={x:d3.transform(b.attr("transform")).translate[0]+c.attr("width")/2,y:d3.transform(b.attr("transform")).translate[1]+c.attr("height")/2,radius:10}})}function i(){p.clusters={},p.clusterPoints={},p.nodes=a.obras.filter(function(a){return a.etapa}).map(function(a){var b="e"+(Math.floor(4*Math.random())+1),c=10,a={cluster:b,radius:c,data:a};return(!p.clusters[b]||c>p.clusters[b].radius)&&(p.clusters[b]=a),a}),d3.selectAll("g.etapas-item").each(function(a){var b=d3.select(this),c=b.select("rect");p.clusterPoints["e"+a]={x:d3.transform(b.attr("transform")).translate[0]+c.attr("width")/2,y:d3.transform(b.attr("transform")).translate[1]+c.attr("height")/2,radius:10}})}function j(){p.clusters={},p.clusterPoints={},p.nodes=a.obras.filter(function(a){return a.id}).map(function(a){var b="i"+a.id,c=5,a={cluster:b,radius:c,data:a};p.clusters[b]=a;var d=-1*(Math.random()*(34.50001-34.70001)+34.70001).toFixed(5),e=-1*(Math.random()*(58.30001-58.50001)+58.50001).toFixed(5),f=o.mapProjection([e,d]);return p.clusterPoints[b]={x:f[0],y:f[1],radius:5},a})}function k(){p.colors=d3.scale.category20(),p.force=d3.layout.force().nodes(p.nodes).size([o.w,o.h]).gravity(0).charge(1).on("tick",l).start(),p.circles=p.group.selectAll("circle.obra").data(p.nodes),p.circles.enter().append("circle").classed("obra",!0),p.circles.attr("id",function(a){return"e"+a.data.id}).style("fill",function(a){return p.colors(a.data.id)}).call(p.force.drag),p.circles.transition().attr("r",function(a){return a.radius}),p.circles.exit().remove()}function l(a){p.circles.each(m(10*a.alpha*a.alpha)).each(n(.5)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}function m(a){return function(b){var c=p.clusters[b.cluster],d=1;if(c){c===b&&(p.clusterPoints?(c=p.clusterPoints[b.cluster],c={x:c.x,y:c.y,radius:-c.radius},d=.5*Math.sqrt(b.radius)):(c={x:o.w/2,y:o.h/2,radius:-b.radius},d=.1*Math.sqrt(b.radius)));var e=b.x-c.x,f=b.y-c.y,g=Math.sqrt(e*e+f*f),h=b.radius+c.radius;g!=h&&(g=(g-h)/g*a*d,b.x-=e*=g,b.y-=f*=g,c.x+=e,c.y+=f)}}}function n(a){var b=d3.geom.quadtree(p.nodes);return function(c){var d=c.radius+10,e=c.x-d,f=c.x+d,g=c.y-d,h=c.y+d;b.visit(function(b,d,i,j,k){if(b.point&&b.point!==c){var l=c.x-b.point.x,m=c.y-b.point.y,n=Math.sqrt(l*l+m*m),o=c.radius+b.point.radius+5;o>n&&(n=(n-o)/n*a,c.x-=l*=n,c.y-=m*=n,b.point.x+=l,b.point.y+=m)}return d>f||e>j||i>h||g>k})}}a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.timeoutId;var o={},p={};a.isSmallDevice,a.selectedGroup="comunas",b.getAll().then(function(b){console.log(b),a.obras=b,c(),$(window).resize(function(){clearTimeout(a.timeoutId),a.timeoutId=setTimeout(c,1e3)})});var q={comunas:e,etapas:f,map:d},r={comunas:h,etapas:i,map:j},s={comunas:!1,etapas:!1,map:!1};a.showGroup=function(b){a.selectedGroup!=b&&(o.svg.selectAll(".child").style("opacity",0),a.selectedGroup=b),q[b]();var c=s[b]?100:1100;s[b]=!0,setTimeout(function(){r[b](),k()},c)}}]),angular.module("obrasMduytApp").controller("ObraCtrl",["$scope","DataService","$routeParams",function(a,b,c){a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),a.obraId=c.id;var d={url:"//tiles1.usig.buenosaires.gob.ar/mapcache/tms/1.0.0/amba_con_transporte_3857@GoogleMapsCompatible/{z}/{x}/{y}.png",format:"tms",builder:"tms",baseLayer:!0,options:{maxZoom:18,minZoom:9,attribution:'USIG (<a href="http://www.buenosaires.gob.ar" target="_blank">GCBA</a>), © <a href="http://www.openstreetmap.org/copyright/en" target="_blank">OpenStreetMap</a> (ODbL)',tms:!0}};a.titles=d,angular.extend(a,{london:{lat:-34.6045645,lng:-58.3828143,zoom:14},markers:{},tiles:d}),b.getById(c.id).then(function(b){console.log(b),a.obra=b,angular.extend(a,{markers:{m1:{lat:parseFloat(b.lat),lng:parseFloat(b.lng),focus:!0,message:b.nombre}}})})}]),angular.module("obrasMduytApp").controller("EntornoCtrl",["$scope","DataService","$routeParams",function(a,b,c){a.pymChild=new pym.Child({polling:1e3}),a.pymChild.sendHeight(),b.getByEntorno(c.entorno).then(function(b){a.entorno=c.entorno,console.log(b),a.obras=b})}]),angular.module("obrasMduytApp").run(["$templateCache",function(a){a.put("views/entorno.html",'<div class="row"> <div class="col-md-12"> <h1>Entorno: {{entorno}}</h1> <p>Obras: {{obras.length}}</p> <p ng-repeat="obra in obras"> Obra: {{$index+1}} -> {{obra}} </p> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Galería]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Datos]</h4> </div> </div> <div class="row"> <div class="col-md-12"> <h4> Ubicación de Obra </h4> <leaflet lf-center="london" tiles="tiles" markers="markers" defaults="defaults" width="100%" height="350px"></leaflet> </div> </div>'),a.put("views/home.html",'<div class="row"> <div class="col-md-12"> <h1>HOME</h1> <p>Cargadas: {{obras.length}} obras</p> </div> </div> <div class="row"> <div class="col-sm-10"> <div id="home-chart-container"></div> </div> <div class="col-sm-2"> <a class="btn btn-default btn-block" ng-click="showGroup(\'map\')">Mapa</a> <a class="btn btn-default btn-block" ng-click="showGroup(\'comunas\')">Comunas</a> <a class="btn btn-default btn-block" ng-click="showGroup(\'etapas\')">Etapas</a> </div> </div> <div class="row"> <div class="col-md-12"> <h4>[Sankey]</h4> </div> </div>'),a.put("views/obra.html",'<div class="row obra"> <div class="col-md-12"> <h1>Obra {{obra.id}}: {{obra.nombre}}</h1> <div class="row"> <div class="col-md-8"> <slick class=".slider-for" asnavfor=".slider-nav" infinite="true" slides-to-show="1" slides-to-scroll="1"> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> </slick> <slick class="slider-nav" asnavfor=".slider-nav" infinite="true" dots="true" centermode="true" focusonselect="true" slides-to-show="3" slides-to-scroll="1"> <div><img ng-src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> <div><img src="http://www.eldiariodebuenosaires.com/files/2016/01/Calle.jpg"></div> </slick> <p> {{obra.descripcion}} </p> </div> <div class="col-md-4 ficha-tecnica"> <h4> Ficha técnica de Licitación </h4> <div class="etapa"> <p> Tipo de Obra: <strong ng-repeat="tipo in obra.tipo">{{tipo}}</strong> </p> </div> <p> Area Responsable: <strong> {{obra.area_responsable}}</strong></p> <p> Empresas <ul> <li ng-repeat="empresa in obra.licitacion_oferta_empresas"> <strong>{{empresa}} <i class="detalle-frame-icon glyphicon glyphicon-info-sign" data-container="body" title="{{nota}}" data-toggle="popover" data-placement="bottom" data-content="Fuente: {{fuente}}"></i> </strong> </li> </ul> </p> <p> Etapa: <strong>{{obra.etapa}} </strong> </p> <p> Estado </p> <div class="progress"> <div class="progress-bar bg-color-{{obra.slug}}" role="progressbar" ng-style="{ \'width\': obra.porcentaje_avance + \'%\' }"> <div class="progressbar-w" ng-show="!obra.porcentaje_avance"><p></p> </div> <span class="progressbar-w" ng-hide="obra.porcentaje_avance<22 || !obra.porcentaje_avance"> </span> </div> <div class="progress-w" ng-show="obra.porcentaje_avance<22" ng-style="{ \'width\': (100 - obra.porcentaje_avance) + \'%\' }"></div> </div> <p> Plazo total: <strong> {{obra.plazo_meses}} meses </strong> </p> <p> Inicio : {{obra.fecha_inicio}} // Fin : {{obra.fecha_fin_inicial}} </p> <p> Cantidad de Beneficiaros: <strong> {{obra.benficiarios}}</strong> </p> <p> Mano de Obra <strong> {{obra.mano_obra}} </strong> </p> <p> Monto Contrato: <strong> {{obra.monto_contrato | currency}} </strong> </p> <p> Monto Actualizado: <strong> {{obra.licitacion_presupuesto_oficial | currency}} </strong> </p> <p> <a href=""><i class="detalle-frame-icon glyphicon glyphicon glyphicon-download-alt"> </i> Descargar Informe </a> </p> </div> </div> </div> </div> <div class="row"> <div class="col-md-12"> <h4> Ubicación de Obra </h4> <leaflet lf-center="london" tiles="tiles" markers="markers" defaults="defaults" width="100%" height="350px"></leaflet> </div> </div>')}]);